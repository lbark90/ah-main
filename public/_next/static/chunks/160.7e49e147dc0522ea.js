"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[160],{5160:function(e,t,n){n.r(t),n.d(t,{default:function(){return l}});var o=n(7437),r=n(2265),s=n(9376),a=n(2084),i=n(9976);let c=e=>{let{isSpeaking:t,size:n=128,colorClass:r="bg-blue-500"}=e;return(0,o.jsxs)("div",{className:"relative flex items-center justify-center",style:{width:n,height:n},children:[(0,o.jsx)("div",{className:"absolute rounded-full ".concat(r," ").concat(t?"animate-pulse-ring":""),style:{width:n,height:n,opacity:.6}}),(0,o.jsx)("div",{className:"absolute rounded-full ".concat(r," ").concat(t?"animate-pulse":""),style:{width:.8*n,height:.8*n,opacity:.8}}),(0,o.jsx)("div",{className:"rounded-full ".concat(r),style:{width:.65*n,height:.65*n}})]})};function l(e){let{userName:t="User",memorializedName:n="Sarah Johnson",onConversationEnd:l,userDob:f=""}=e,g=(0,s.useRouter)(),{user:h}=(0,a.a)(),{assistant:p,conversation:v,isLoading:b}=(0,i.P)(),[y,w]=(0,r.useState)("initializing"),N=()=>{let e=(null==h?void 0:h.id)||(null==h?void 0:h.username)||"";return e||console.log("No user ID found in user object:",h),e};(0,r.useEffect)(()=>{console.log("Current user in ConversationUI:",h),console.log("Current loading state:",y),b||h||(console.log("No user detected after initial load, redirecting to login"),g.push("/login")),h&&w("user-loaded")},[h,g,b,y]);let x=(0,r.useRef)(!0),[S,k]=(0,r.useState)(!1),[E,j]=(0,r.useState)(!1),[I,R]=(0,r.useState)([]),[C,D]=(0,r.useState)(null),[O,A]=(0,r.useState)(null),[L,_]=(0,r.useState)(null),[P,W]=(0,r.useState)(null),[U,z]=(0,r.useState)(!1),[M,T]=(0,r.useState)(""),[q,J]=(0,r.useState)(!1),[F,B]=(0,r.useState)(!1),[G,H]=(0,r.useState)(null),[V,K]=(0,r.useState)({}),Y=(0,r.useRef)(null),$=(0,r.useRef)(null),Q=(0,r.useRef)(null),X=(0,r.useRef)((null==h?void 0:h.username)||"user_".concat(Date.now())),Z=(0,r.useRef)([]),ee=(0,r.useRef)("");(0,r.useRef)(""),(0,r.useRef)(!1);let[et,en]=(0,r.useState)(""),[eo,er]=(0,r.useState)(""),[es,ea]=(0,r.useState)([]),[ei,ec]=(0,r.useState)(!1);(0,r.useEffect)(()=>{Z.current=es},[es]),(0,r.useEffect)(()=>{ee.current=eo},[eo]);let[el,eu]=(0,r.useState)(!1),ed=(0,r.useRef)(null),[em,ef]=(0,r.useState)(!1),[eg,eh]=(0,r.useState)(!1),[ep,ev]=(0,r.useState)(!1);(0,r.useRef)([]),(0,r.useRef)(!1),(0,r.useRef)(!1),(0,r.useRef)(0);let eb=(0,r.useRef)(null),ey=(0,r.useRef)(null),ew=(0,r.useRef)(null),eN=(0,r.useRef)(!1),ex=(0,r.useRef)(null);(0,r.useRef)(!1),(0,r.useRef)(0);let eS=(0,r.useRef)(new Set),ek=(0,r.useRef)(new Set),eE=(0,r.useRef)(new Map);(0,r.useRef)(null),(0,r.useRef)(0),(0,r.useRef)(0);let ej=(0,r.useRef)(0),eI=(0,r.useRef)(!1),eR=(0,r.useRef)(!1),eC=()=>{try{let e=window.AudioContext||window.webkitAudioContext;if(!e)return console.error("Web Audio API not supported in this browser"),!1;if(!Y.current)return Y.current=new e,console.log("Audio context initialized successfully"),"suspended"===Y.current.state&&console.log("Audio context is suspended - this is normal, will resume on user interaction"),!0;return"suspended"===Y.current.state&&Y.current.resume().then(()=>{console.log("Existing audio context resumed")}).catch(e=>{console.error(e)}),!0}catch(e){return console.error(e),!1}},eD=async()=>{if(el&&ed.current)return console.log("Microphone already initialized"),ed.current;if("undefined"==typeof navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return console.error("Microphone not supported or detected in this browser"),eu(!0),A("No microphone detected. Please connect a microphone or use a supported browser."),null;console.log("Requesting microphone permission...");try{let e=await navigator.mediaDevices.getUserMedia({audio:!0});console.log("âœ… Microphone access granted"),eu(!0),ed.current=e;try{let t=window.AudioContext||window.webkitAudioContext;if(t){let n=new t,o=n.createAnalyser(),r=n.createMediaStreamSource(e);r.connect(o),o.fftSize=256;let s=o.frequencyBinCount,a=new Uint8Array(s);o.getByteFrequencyData(a);let i=0;for(let e=0;e<s;e++)i+=a[e];let c=i/s;console.log("Microphone test - audio level: ".concat(Math.round(c))),r.disconnect(),setTimeout(()=>n.close(),500)}else console.error("Web Audio API not supported for microphone test")}catch(e){console.error(e)}return e}catch(e){return console.error(e),eu(!0),A("Unable to access microphone. Please check your device and permissions."),null}},eO=()=>{ec(!1),console.log("Starting push-to-talk speech recognition"),en(""),er(""),ea([]),J(!0),eD().then(()=>{try{let e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)throw Error("Speech recognition not supported in this browser");let t=new e;Q.current=t,t.continuous=!1,t.interimResults=!0,t.lang="en-US",t.maxAlternatives=1,t.onstart=function(){console.log("Speech recognition started"),J(!0)},t.onerror=function(e){console.error(e),J(!1)},t.onresult=function(e){let t="",n="";for(let o=e.resultIndex;o<e.results.length;o++){let r=e.results[o][0].transcript;e.results[o].isFinal?(n+=r,console.log('Speech recognition final result: "'.concat(r,'"')),ea(e=>{let t=[...e,r];return console.log("Updated finalResults: [".concat(t.join(", "),"]")),t})):t+=r}t&&(console.log('Speech recognition interim result: "'.concat(t,'"')),er(t)),n&&(console.log('Adding final text to transcript: "'.concat(n,'"')),en(e=>{let t=(e?e+" ":"")+n;return console.log('Updated transcript: "'.concat(t,'"')),t}))},t.onend=function(){console.log("Speech recognition ended"),J(!1),eo&&(ea(e=>[...e,eo]),en(e=>e+" "+eo),er(""))},t.start(),console.log("Speech recognition API initialized and started")}catch(e){console.error(e),J(!1),Q.current=null}}).catch(e=>{console.error(e),J(!1)})},eA=()=>{if(console.log("Stopping push-to-talk"),ei)return;let e=Q.current;if(e)try{console.log("Recognition active: Yes"),e.stop(),console.log("Speech recognition stopped")}catch(e){console.error("Error stopping recognition: ".concat(e instanceof Error?e.message:e))}else console.log("Recognition active: No");setTimeout(()=>{let e=Z.current.join(" ").trim()||ee.current.trim();console.log('Final transcript prepared from finalResults: "'.concat(e,'"')),e?ei?console.log("Transcript already sent, skipping"):(console.log('Sending transcript: "'.concat(e,'"')),ec(!0),eL(e),T(e),e_(e)):console.log("No speech detected during the session"),Q.current=null,J(!1)},1e3)},eL=e=>{if(!e||!e.trim())return console.log("No speech to send"),!1;let t=ey.current;if(!(t&&t.readyState===WebSocket.OPEN)){console.error("Cannot send message - socket not connected");let e=N();return e&&!eN.current&&(console.log("Attempting to reconnect socket before sending message"),eP(e,G||"",V.firstName||"",V.lastName||"",V.dob||"",V.profileDocument||"")),!1}try{if(console.log('Sending message to server: "'.concat(e.trim(),'"')),t&&t.readyState===WebSocket.OPEN)return t.send(JSON.stringify({type:"user_message",user_id:X.current,message:e.trim(),timestamp:Date.now()})),!0;return!1}catch(e){return console.error("Error sending transcript:",e),!1}},e_=async e=>{let t=e||M;if(t.trim()&&!U)try{let e;z(!0);let n=t.trim(),o="req_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9));T("");let r=V;try{let t=N();e=await u(t),r.firstName||r.lastName||(r=await d(t))}catch(e){throw console.error("Voice ID error:",e),Error("Could not start conversation: voice configuration issue.")}if(eS.current.clear(),ek.current.clear(),eE.current.clear(),"string"==typeof n&&eE.current.set(o,n),!F&&(B(!0),C&&C.readyState===WebSocket.OPEN)){let t={type:"start_conversation",message:n,request_id:o,user_id:N(),voice_id:e,firstName:r.firstName||"",lastName:r.lastName||"",dob:r.dob||"",profileDocument:r.profileDocument||"",text:n};console.log("Sending start conversation with voice ID and profile info:",t),C.send(JSON.stringify(t));return}if(C&&C.readyState===WebSocket.OPEN){console.log("Sending message with request ID: ".concat(o," and voice ID: ").concat(e));try{let t={type:"user_message",message:n,request_id:o,user_id:N(),voice_id:e,firstName:r.firstName||"",lastName:r.lastName||"",dob:r.dob||"",profileDocument:r.profileDocument||"",text:n};C.send(JSON.stringify(t));let s=Array.from(eE.current.entries());if(s.length>5){let e=s[0][0];eE.current.delete(e)}}catch(e){throw console.error("Socket communication error:",e),Error("Failed to send message through socket")}}else throw Error("Communication failed - socket not connected");fetch("/api/socket-debug",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:N(),action:"send_message",timestamp:new Date().toISOString(),message_length:n.length,socket_state:C?C.readyState:"null",connected:E})}).catch(e=>console.error("Socket debug API error:",e))}catch(e){console.error(e),e instanceof Error&&(e.message.includes("voice configuration")||e.message.includes("500")||e.message.includes("401")||e.message.includes("403")||e.message.includes("429"))}finally{z(!1)}};async function eP(e,t,n,o,r,s){if(ey.current&&(ey.current.readyState===WebSocket.OPEN||ey.current.readyState===WebSocket.CONNECTING))return console.log("Socket already exists and is in OPEN or CONNECTING state, reusing existing connection"),ey.current;if(eR.current)return console.log("Socket connection already in progress, skipping duplicate initialization"),null;eR.current=!0,eN.current=!0;try{var a;if(console.log("Initializing WebSocket from ".concat((null===(a=Error().stack)||void 0===a?void 0:a.split("\n")[2])||"unknown location")),s||(s="".concat(e,"/profile_description/").concat(e,"_memorial_profile.txt"),console.log("Constructed profileDocument path:",s)),!t||!n||!o||!r){console.log("Fetching missing parameters from API...");let[a,i]=await Promise.all([t?Promise.resolve(t):u(e),fetch("/api/user/fetch-credentials?userId=".concat(e)).then(e=>{if(!e.ok)throw Error("Failed to fetch credentials: ".concat(e.statusText));return e.json()})]);t=t||a,n=n||i.firstName||"",o=o||i.lastName||"",(r=r||i.dob||"")||(console.log("DOB is still empty after fetching, using placeholder"),r="unknown"),console.log("Updated parameters after fetching:",{userId:e,voiceId:t,firstName:n,lastName:o,dob:r,profileDocument:s})}if(!e||!t||!n||!o||!r||!s)return console.warn("Cannot initialize WebSocket: Missing required parameters",{userId:e,voiceId:t,firstName:n,lastName:o,dob:r,profileDocument:s}),eR.current=!1,eN.current=!1,null;console.log("Initializing WebSocket for user ID: ".concat(e));let i="https:"===window.location.protocol?"wss:":"ws:",c="".concat(i,"//").concat("localhost",":").concat("8080"),l=new WebSocket(c);return ey.current=l,l.onopen=function(){console.log("WebSocket connection established successfully"),eR.current=!1;let a={type:"connection_init",user_id:e,voice_id:t,firstName:n,lastName:o,dob:r,profileDocument:s,text:"connection_init",value:"init"};console.log("Sending connection_init message:",JSON.stringify(a)),l.send(JSON.stringify(a))},l.onerror=function(e){console.error("WebSocket error occurred:",e),eR.current=!1,eN.current=!1},l.onclose=function(e){console.log("WebSocket connection closed: ".concat(e.code," ").concat(e.reason)),eR.current=!1,eN.current=!1},l.onmessage=function(e){console.log("Received message from server:",e.data);try{let t=JSON.parse(e.data);if(console.log("Parsed message:",t),t&&"audio_chunk"===t.type&&t.audio_data){let e=t.audio_data,n=atob(e),o=n.length,r=new Uint8Array(o);for(let e=0;e<o;e++)r[e]=n.charCodeAt(e);let s=new Blob([r],{type:"audio/wav"}),a=URL.createObjectURL(s),i=new Audio(a);F?i.play().catch(e=>console.warn("Audio playback blocked:",e)):i.play().catch(e=>console.warn("Audio playback blocked:",e))}}catch(e){console.error("Error parsing message:",e)}},l}catch(e){return console.error("Error in initializeSocket:",e),eR.current=!1,eN.current=!1,null}}(0,r.useEffect)(()=>{x.current=!0,console.log("Component mount effect running with user:",null==h?void 0:h.id);let e=ej.current+1;ej.current=e,console.log("Component mount count:",e),eI.current=!1;let t=document.createElement("div");t.setAttribute("id","conversation-ui-mounted"),t.setAttribute("data-conversation-mounted","true"),t.setAttribute("data-user-id",(null==h?void 0:h.id)||""),document.body.appendChild(t),k(!0),eC(),eD();let n=function(){let e=!1,t=t=>{32!==t.keyCode||e||(t.preventDefault(),e=!0,document.dispatchEvent(new CustomEvent("push-to-talk-start")))},n=t=>{32===t.keyCode&&e&&(t.preventDefault(),e=!1,document.dispatchEvent(new CustomEvent("push-to-talk-stop")))};return window.addEventListener("keydown",t),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",n)}}();return X.current=N()||"user_".concat(Date.now()),ev(!0),()=>{x.current=!1,console.log("Component unmounting - cleaning up resources");let e=document.getElementById("conversation-ui-mounted");e&&e.remove(),eI.current=!1;let t=ey.current;if(t&&t.readyState===WebSocket.OPEN){console.log("Closing existing WebSocket connection");try{if(G)try{let e=JSON.stringify({type:"disconnect",user_id:N(),voice_id:G,firstName:V.firstName||"",lastName:V.lastName||"",dob:V.dob||"",profileDocument:V.profileDocument||"",text:"disconnect",value:"cleanup",timestamp:Date.now()});console.log("Sending final disconnect on unmount:",e),t.send(e),console.log("Waiting briefly for disconnect message to send")}catch(e){console.error("Error sending final disconnect message:",e)}setTimeout(()=>{try{t.readyState===WebSocket.OPEN&&(t.close(1e3,"Component unmounting"),console.log("Socket closed on unmount"))}catch(e){console.error("Error closing socket on unmount:",e)}},100)}catch(e){console.error("Error during socket cleanup:",e);try{t.close()}catch(e){console.error("Error force-closing socket:",e)}}}else t&&console.log("Socket not in OPEN state during cleanup, current state:",t.readyState===WebSocket.CONNECTING?"CONNECTING":t.readyState===WebSocket.CLOSED?"CLOSED":t.readyState===WebSocket.CLOSING?"CLOSING":"UNKNOWN");if(ey.current=null,D(null),j(!1),Q.current){try{Q.current.stop()}catch(e){}Q.current=null}if($.current){try{$.current.stop()}catch(e){}$.current=null}if(Y.current){try{Y.current.close()}catch(e){}Y.current=null}if(ed.current){try{ed.current.getTracks().forEach(e=>e.stop())}catch(e){}ed.current=null}eb.current&&(clearInterval(eb.current),eb.current=null),n()}},[h]),(0,r.useEffect)(()=>(console.log("Running socket initialization effect"),w("socket-initializing"),(async()=>{if(!X.current){let e=N();e&&(X.current=e)}if(ey.current&&(ey.current.readyState===WebSocket.OPEN||ey.current.readyState===WebSocket.CONNECTING)){console.log("Socket already exists in useEffect, not reinitializing"),w("socket-already-connected"),ev(!0);return}if(eR.current){console.log("Socket connection already in progress in useEffect, skipping"),w("socket-connecting");return}if(!G||!V.firstName||!V.lastName||!V.dob||!V.profileDocument){console.log("Fetching missing user profile and voiceId..."),w("fetching-profile-data");try{let e=await u(X.current),t=await d(X.current);H(e),K(t),w("profile-data-fetched")}catch(e){console.error("Error fetching user data:",e),w("profile-fetch-error"),ev(!0)}return}let e={userId:X.current,voiceId:G||"[will be fetched]",firstName:V.firstName||(null==h?void 0:h.firstName)||"[not provided]",lastName:V.lastName||(null==h?void 0:h.lastName)||"[not provided]",dob:V.dob||(null==h?void 0:h.dob)||"[not provided]",profileDocument:V.profileDocument||"[not provided]"};console.log("Socket initialization with available data:",e),console.log("Initializing socket with user ID:",X.current),e.userId&&e.voiceId&&e.firstName&&e.lastName&&e.dob&&e.profileDocument?(console.log("All prerequisites met, initializing socket connection"),w("socket-connecting-with-data"),eP(e.userId,e.voiceId,e.firstName,e.lastName,e.dob,e.profileDocument).then(t=>{t?(eb.current||m(t,e.userId),w("socket-connected")):w("socket-connection-failed"),ev(!0)})):(console.log("Missing required data for socket initialization:",e),w("missing-required-data"),setTimeout(()=>{ep||(console.log("Forcing loaded state after timeout"),ev(!0))},5e3))})(),()=>{ey.current&&(console.log("Cleaning up WebSocket connection"),ey.current.readyState===WebSocket.OPEN&&ey.current.close(1e3,"Component unmounting"),ey.current=null,eR.current=!1,eN.current=!1),eb.current&&(clearInterval(eb.current),eb.current=null)}),[]),(0,r.useEffect)(()=>{if(!ey.current&&!eR.current&&X.current&&(G||V.voiceId)&&(V.firstName||(null==h?void 0:h.firstName))&&(V.lastName||(null==h?void 0:h.lastName))&&(V.dob||(null==h?void 0:h.dob))&&V.profileDocument){let e={userId:X.current,voiceId:G||"[will be fetched]",firstName:V.firstName||(null==h?void 0:h.firstName)||"[not provided]",lastName:V.lastName||(null==h?void 0:h.lastName)||"[not provided]",dob:V.dob||(null==h?void 0:h.dob)||"[not provided]",profileDocument:V.profileDocument||"[not provided]"};console.log("Socket initialization with available data:",e),console.log("Initializing socket with user ID:",X.current),eP(e.userId,e.voiceId,e.firstName,e.lastName,e.dob,e.profileDocument).then(t=>{t&&!eb.current&&m(t,e.userId)})}},[G,V]),(0,r.useEffect)(()=>{let e=()=>{x.current&&eO()},t=()=>{x.current&&eA()},n=e=>{x.current&&_(e.detail.error)},o=e=>{if(x.current)try{var t;if(console.log("Received audio event with data length:",(null===(t=e.detail.audio)||void 0===t?void 0:t.length)||0),!e.detail.audio){console.warn("No audio data in event");return}let n=e.detail.audio,o=eW(n,"audio/mpeg");if(!o||0===o.size){console.error("Failed to create audio blob or blob is empty");return}let r=URL.createObjectURL(o);console.log("Created audio URL:",r);let s=ex.current;if(!s){console.error("Audio element ref is null");return}P&&URL.revokeObjectURL(P.src),s.src=r,W(s),eh(!0),s.onended=()=>{console.log("Audio playback ended"),eh(!1),URL.revokeObjectURL(r)},s.onerror=e=>{console.error("Audio playback error:",e),eh(!1),URL.revokeObjectURL(r)},s.play().catch(e=>{console.error("Failed to play audio:",e),eh(!1)})}catch(e){console.error("Error handling audio event:",e),eh(!1)}};return document.addEventListener("push-to-talk-start",e),document.addEventListener("push-to-talk-stop",t),document.addEventListener("socket-error",n),document.addEventListener("assistant-audio",o),()=>{document.removeEventListener("push-to-talk-start",e),document.removeEventListener("push-to-talk-stop",t),document.removeEventListener("socket-error",n),document.removeEventListener("assistant-audio",o)}},[]);let eW=(e,t)=>{try{let n=e.replace(/^data:audio\/\w+;base64,/,""),o=atob(n),r=new Uint8Array(o.length);for(let e=0;e<o.length;e++)r[e]=o.charCodeAt(e);return new Blob([r],{type:t})}catch(e){return console.error("Error converting base64 to blob:",e),null}};return((0,r.useEffect)(()=>{ew.current&&ew.current.scrollIntoView({behavior:"smooth"})},[I]),h)?ep?(0,o.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[80vh] bg-[#0f172a]",children:[(0,o.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,o.jsx)("div",{className:"flex-none pt-16 pb-6 flex items-center justify-center",children:(0,o.jsx)("div",{className:"relative",children:(0,o.jsx)(c,{isSpeaking:eg,size:112})})}),(0,o.jsxs)("div",{className:"flex-none text-center pb-10",children:[(0,o.jsx)("h2",{className:"text-2xl text-white font-normal",children:q?"Listening...":eg?"".concat(n," is speaking..."):"Ready to start the conversation"}),(0,o.jsx)("p",{className:"text-slate-400 mt-2",children:q?"Speak now, we are capturing your input.":eg?"The AI is responding to your message.":"Press and hold the spacebar to speak."})]})]}),(0,o.jsx)("div",{className:"flex justify-center items-center pb-16",children:(0,o.jsx)("button",{className:"bg-slate-800 hover:bg-slate-700 text-white rounded-full p-6 flex items-center justify-center shadow-lg focus:outline-none transition-all",onMouseDown:eO,onMouseUp:eA,onTouchStart:eO,onTouchEnd:eA,children:(0,o.jsx)("svg",{className:"w-8 h-8",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})})})}),(0,o.jsx)("div",{className:"text-center pb-8",children:(0,o.jsxs)("p",{className:"text-slate-500 text-sm",children:["Press and hold to speak or press ",(0,o.jsx)("kbd",{className:"px-2 py-0.5 bg-slate-800 rounded text-xs",children:"Space"})]})}),(0,o.jsx)(()=>q?(0,o.jsxs)("div",{className:"fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-700 text-white py-3 px-6 rounded-full shadow-lg animate-pulse flex items-center space-x-3 z-20",children:[(0,o.jsxs)("div",{className:"relative flex space-x-1",children:[(0,o.jsx)("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,o.jsx)("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,o.jsx)("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),(0,o.jsx)("span",{children:"Listening..."})]}):null,{}),(0,o.jsx)(()=>eg?(0,o.jsxs)("div",{className:"fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-700 text-white py-3 px-6 rounded-full shadow-lg z-20 flex items-center space-x-3",children:[(0,o.jsxs)("div",{className:"relative flex space-x-1",children:[(0,o.jsx)("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-pulse",style:{animationDelay:"0ms"}}),(0,o.jsx)("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-pulse",style:{animationDelay:"300ms"}}),(0,o.jsx)("span",{className:"w-2 h-2 bg-blue-400 rounded-full animate-pulse",style:{animationDelay:"600ms"}})]}),(0,o.jsxs)("span",{children:[n," is speaking..."]})]}):null,{}),(0,o.jsx)("audio",{ref:ex,style:{display:"none"}})]}):(0,o.jsx)("div",{className:"flex items-center justify-center h-full bg-[#0a102a]",children:(0,o.jsxs)("div",{className:"flex flex-col items-center",children:[(0,o.jsx)("div",{className:"w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"}),(0,o.jsx)("p",{className:"mt-4 text-slate-300",children:"Loading conversation..."}),(0,o.jsxs)("p",{className:"mt-2 text-sm text-slate-400",children:["Current state: ",y]}),"missing-required-data"===y&&(0,o.jsxs)("div",{className:"mt-4 text-xs text-red-400 max-w-md text-center",children:[(0,o.jsx)("p",{children:"Could not retrieve all required user data. Try refreshing the page."}),(0,o.jsx)("button",{onClick:()=>window.location.reload(),className:"mt-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-md",children:"Refresh Page"})]})]})}):(console.log("Showing auth required UI while checking user state"),(0,o.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-[#0a102a]",children:(0,o.jsxs)("div",{className:"p-8 bg-slate-800 rounded-lg shadow-lg max-w-md",children:[(0,o.jsx)("div",{className:"flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100/10",children:(0,o.jsx)("svg",{className:"w-8 h-8 text-blue-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})}),(0,o.jsx)("h2",{className:"text-xl text-white mb-4 font-semibold text-center",children:"Authentication Required"}),(0,o.jsx)("p",{className:"text-slate-300 mb-6 text-center",children:"Please log in to access the conversation feature."}),(0,o.jsxs)("button",{onClick:()=>g.push("/login"),className:"w-full py-2 px-4 bg-blue-600 hover:bg-blue-500 transition-colors text-white font-medium rounded-lg flex items-center justify-center",children:[(0,o.jsx)("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"})}),"Go to Login"]})]})}))}async function u(e){try{let t=await fetch("/api/voice/get-voice-id?userId=".concat(e));if(!t.ok)throw Error("Failed to fetch voice ID: ".concat(t.status));return(await t.json()).voiceId||""}catch(e){return console.error("Error fetching voice ID:",e),""}}async function d(e){try{console.log("Fetching user profile for ".concat(e));let t=await fetch("/api/user/profile?userId=".concat(encodeURIComponent(e)));if(!t.ok)throw Error("Failed to fetch user profile: ".concat(t.status));let n=await t.json();return console.log("Successfully fetched user profile:",n),{firstName:n.firstName||"",lastName:n.lastName||"",dob:n.dob||"",profileDocument:n.profileDocument||""}}catch(e){return console.error("Error fetching user profile:",e),{firstName:"",lastName:"",dob:"",profileDocument:""}}}function m(e,t){return e&&e.readyState===WebSocket.OPEN?(console.log("Starting heartbeat interval"),setInterval(()=>{!function(e,t){try{e.readyState===WebSocket.OPEN&&(console.log("Sending heartbeat message"),e.send(JSON.stringify({type:"heartbeat",message:"keepalive",user_id:t})))}catch(e){console.error("Error sending heartbeat:",e)}}(e,t)},3e4)):null}},9976:function(e,t,n){n.d(t,{$:function(){return i},P:function(){return a}});var o=n(7437),r=n(2265);let s=(0,r.createContext)({assistant:null,conversation:null,isLoading:!0,isProcessing:!1,createAssistant:async()=>({assistantId:"",name:"",status:"",createdAt:"",userId:""}),startConversation:async()=>({conversationId:"",messages:[]}),sendMessage:async()=>{}}),a=()=>(0,r.useContext)(s);function i(e){let{children:t}=e,[n,a]=(0,r.useState)(null),[i,c]=(0,r.useState)(null),[l,u]=(0,r.useState)(!0),[d,m]=(0,r.useState)(!1);(0,r.useEffect)(()=>{(()=>{try{let e=localStorage.getItem("aliveHereAssistant");e&&a(JSON.parse(e));let t=localStorage.getItem("aliveHereConversation");t&&c(JSON.parse(t))}catch(e){console.error("Error loading assistant data:",e)}finally{u(!1)}})()},[]);let f=async e=>{try{m(!0);let t={assistantId:"assistant_".concat(Date.now()),name:e,status:"active",createdAt:new Date().toISOString(),userId:"user_".concat(Date.now())};return localStorage.setItem("aliveHereAssistant",JSON.stringify(t)),a(t),t}catch(e){throw console.error("Error creating assistant:",e),e}finally{m(!1)}},g=async e=>{try{m(!0);let t=n;t||(t=await f("AI Assistant"));let o={conversationId:"conv_".concat(Date.now()),messages:[{role:"user",content:e,timestamp:new Date().toISOString()}]};return localStorage.setItem("aliveHereConversation",JSON.stringify(o)),c(o),o}catch(e){throw console.error("Error starting conversation:",e),e}finally{m(!1)}},h=async e=>{try{if(m(!0),!n||!i)throw Error("No active conversation");let t=[...i.messages,{role:"user",content:e,timestamp:new Date().toISOString()}],o={...i,messages:t};localStorage.setItem("aliveHereConversation",JSON.stringify(o)),c(o)}catch(e){throw console.error("Error sending message:",e),e}finally{m(!1)}};return(0,o.jsx)(s.Provider,{value:{assistant:n,conversation:i,isLoading:l,isProcessing:d,createAssistant:f,startConversation:g,sendMessage:h},children:t})}},9376:function(e,t,n){var o=n(5475);n.o(o,"usePathname")&&n.d(t,{usePathname:function(){return o.usePathname}}),n.o(o,"useRouter")&&n.d(t,{useRouter:function(){return o.useRouter}})}}]);